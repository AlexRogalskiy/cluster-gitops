---
- name: Create temporary build directory
  tempfile:
    state: directory
    suffix: microshift
  register: tmp_microshift_dir

- name: download microshift selinux policies
  get_url:
    url: "{{ item.url }}"
    dest: "{{ tmp_microshift_dir.path }}/{{ item.name }}"
  with_items:
    - url: https://raw.githubusercontent.com/redhat-et/microshift/main/packaging/selinux/microshift.fc
      name: microshift.fc
    - url: https://raw.githubusercontent.com/redhat-et/microshift/main/packaging/selinux/microshift.te
      name: microshift.te

- name: build microshift selinux policies
  shell: |
    make -f /usr/share/selinux/devel/Makefile -C {{ tmp_microshift_dir.path }}/ && \
    semodule -i {{ tmp_microshift_dir.path }}/microshift.pp

- name: create microshift directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - /var/run/flannel
    - /var/run/kubelet
    - /var/lib/kubelet/pods
    - /var/run/secrets/kubernetes.io/serviceaccount
    - /var/hpvolumes

- name: set selinux policies
  shell: |
    restorecon -v /var/hpvolumes
    restorecon -vR /var/lib/kubelet/pods
    setsebool -P container_manage_cgroup true
